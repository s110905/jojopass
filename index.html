<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
      body { font-family: 'Inter', sans-serif; }
    </style>
  </head>
  <body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-xl shadow-lg p-8 text-center w-full max-w-sm">
      <h1 class="text-3xl font-bold mb-4 text-gray-800">遊園護照驗證</h1>
      
      <div id="status-display" class="font-bold text-2xl mb-4 px-4 py-2 rounded-lg text-white">
        <?= status ?>
      </div>

      <div class="bg-gray-50 rounded-lg p-4 mb-6">
        <p class="text-gray-600 mb-1"><strong>姓名：</strong><span id="name-info" class="text-gray-800 font-medium"> <?= name ?></span></p>
        <p class="text-gray-600 mb-1"><strong>護照ID：</strong><span id="id-info" class="text-gray-800 font-medium"> <?= id ?></span></p>
        <p class="text-gray-600"><strong>有效期限：</strong><span id="expire-info" class="text-gray-800 font-medium"> <?= expire ?></span></p>
      </div>

      <? if (status === "有效" || status === "尚未啟用") { ?>
        <button id="checkin-button" onclick="submitCheckIn()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">
          確認放行並更新
        </button>
      <? } else { ?>
        <p class="text-red-500 font-bold text-lg">此護照無法使用。</p>
      <? } ?>
      
      <p id="message" class="mt-4 font-bold"></p>

    </div>

    <script>
      // Apps Script 會自動將你的網址填入這個變數
      var appsScriptUrl = 'https://script.google.com/macros/s/AKfycby6GEq5F5zNMjmZe8oR3MMG-ULR_gmanW4t-aEVb95SI3OrytnIMjJ2y7aRWnwLcl-f/exec';
      var passportId = '<?= id ?>';
      var visitorName = '<?= name ?>';

      // 根據狀態設定顏色
      document.getElementById('status-display').classList.add('bg-<?= color ?>-500');

      // 點擊按鈕時觸發的函式
      function submitCheckIn() {
        var button = document.getElementById('checkin-button');
        var message = document.getElementById('message');
        
        button.disabled = true;
        button.textContent = '正在更新...';
        message.textContent = '';
        message.classList.remove('text-green-500', 'text-red-500');

        // 使用 fetch API 向 Apps Script 發送 POST 請求
        fetch(appsScriptUrl + '?id=' + passportId, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: passportId })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            message.textContent = '✅ 更新成功！遊客已放行。';
            message.classList.add('text-green-500');
            button.textContent = '已更新';
          } else {
            message.textContent = '❌ 更新失敗：' + data.message;
            message.classList.add('text-red-500');
            button.disabled = false;
            button.textContent = '重新嘗試';
          }
        })
        .catch(error => {
          message.textContent = '❌ 網路錯誤，請檢查連線：' + error.message;
          message.classList.add('text-red-500');
          button.disabled = false;
          button.textContent = '重新嘗試';
        });
      }
    </script>
  </body>
</html>
